# -----------------------------------------------------------------
# Instal Java 8 on Ubuntu
# -----------------------------------------------------------------

sudo apt update
sudo apt-get install openjdk-8-jre

# -----------------------------------------------------------------
# Download TeamCity 2019
# -----------------------------------------------------------------

sudo wget --no-check-certificate "https://download.jetbrains.com/teamcity/TeamCity-2019.1.1.tar.gz"
sudo tar -zxf "TeamCity-2019.1.1.tar.gz"
sudo rm "TeamCity-2019.1.1.tar.gz"

# ----------------------------------------------------------------- 
# Setting up TeamCity start service
# -----------------------------------------------------------------

# 1. Create teamcity.service
sudo touch /etc/systemd/system/teamcity.service

[Unit]
Description=TeamCity Server 2019
After=network.target

[Service]
ExecStart=/home/ubuntu/TeamCity/bin/teamcity-server.sh start
Type=forking
PIDFile=/home/ubuntu/TeamCity/logs/teamcity.pid

[Install]
WantedBy=multi-user.target

# 2. Load changes
sudo systemctl daemon-reload

# 3. Start TeamCity service
sudo systemctl start teamcity.service

# 4. Launch at reboot
sudo systemctl enable teamcity.service

# ----------------------------------------------------------------- 
# Set up MySQL
# -----------------------------------------------------------------

sudo apt-get install mysql-server
sudo mysql_secure_installation utility

# Start the MySQL service
sudo systemctl start mysql

# Launch at reboot
sudo systemctl enable mysql

# Create TeamCity Db and User
CREATE DATABASE teamcity;
CREATE USER 'username'@'localhost' IDENTIFIED BY 'password';
GRANT ALL PRIVILEGES ON teamcity.* TO 'username'@'localhost';

# ----------------------------------------------------------------- 
# Setting up DNS
# -----------------------------------------------------------------

# 1. Create A record pointing to VM's public IP
A     subdomain     public_ip

# 2. Update /etc/hostname
sudo hostnamectl set-hostname subdomain.domain

# 3. Update /etc/hosts
127.0.0.1 subdomain.domain
